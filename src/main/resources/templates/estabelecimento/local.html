<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8"/>
    <title>Estabelecimentos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="icon" type="image/png"
          href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAALklEQVR4AWNAAUGASkIBBqZCVHgP3rj0aCgVGLIMAgT4SBVAw0FEQ4hgRYbBXsG3VEzABx0Qj5N+Jr5wAAAABJRU5ErkJggg=="/>

    <style>
        body {
          font-family: 'Poppins', sans-serif;
          background: linear-gradient(135deg, #8ec5fc, #e0c3fc);
          min-height: 100vh;
          padding: 20px;
        }

        .search-container {
          display: flex;
          align-items: center;
          gap: 10px;
          margin-bottom: 20px;
        }

        .search-container input {
          flex: 1;
        }

        .search-container button {
          font-size: 1.2rem;
          padding: 6px 14px;
        }

        .card {
          border-radius: 12px;
          margin-bottom: 20px;
          display: flex;
          flex-direction: row;
          align-items: center;
          padding: 15px;
          background-color: white;
          box-shadow: 0 4px 8px rgba(0,0,0,0.1);
          transition: transform 0.2s ease-in-out;
          flex-wrap: wrap;
          gap: 10px;
        }

        .card:hover {
          transform: scale(1.01);
        }

        .card img {
          width: 90px;
          height: 90px;
          border-radius: 10px;
          object-fit: cover;
          background-color: #eee;
        }

        .card-body {
          flex: 1;
          min-width: 200px;
        }

        .card-title {
          font-weight: 700;
          margin-bottom: 5px;
          font-size: 1.1rem;
        }

        .card-text {
          margin: 2px 0;
          font-size: 0.9rem;
          color: #555;
        }

        .btn-primary {
          background-color: #7b2cbf;
          border-color: #7b2cbf;
          min-width: 100px;
          height: 38px;
        }

        .btn-primary:hover {
          background-color: #5a189a;
          border-color: #5a189a;
        }

        @media (max-width: 576px) {
          .card {
            flex-direction: column;
            text-align: center;
            padding: 20px;
          }

          .card img {
            margin-bottom: 10px;
          }

          .card-body {
            width: 100%;
          }

          .btn-primary {
            width: 100%;
            margin-top: 10px;
          }
        }
    </style>
</head>
<body>
<div class="container">
    <h2 class="text-center mb-4">Selecione um Estabelecimento</h2>

    <!-- Campo de pesquisa -->
    <div class="search-container">
        <input
                type="text"
                id="inputPesquisa"
                class="form-control"
                placeholder="Digite o nome para buscar"
        />
        <button class="btn btn-outline-secondary" onclick="filtrarEstabelecimentos()" title="Buscar">
            üîç
        </button>
    </div>

    <!-- Container dos cards -->
    <div id="estabelecimentoContainer"></div>
</div>

<script>
    const token = localStorage.getItem("token");
    let listaCompletaEstabelecimentos = [];

    if (!token) {
      alert("Sess√£o expirada. Fa√ßa login novamente.");
      window.location.href = "/login";
    }

    document.addEventListener("DOMContentLoaded", () => {
      const container = document.getElementById("estabelecimentoContainer");

      const inputPesquisa = document.getElementById("inputPesquisa");
  inputPesquisa.addEventListener("keydown", function(event) {
    if (event.key === "Enter") {
      event.preventDefault();
      filtrarEstabelecimentos();
    }
  });

      fetch("/api/estabelecimento/consultar", {
        method: "GET",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        }
      })
      .then(async response => {
        if (response.status === 401) {
          alert("Sess√£o expirada ou token inv√°lido. Fa√ßa login novamente.");
          localStorage.removeItem("token");
          window.location.href = "/login";
          return;
        }

        const dados = await response.json();

        if (dados["Status: "] === 4 || dados["Descri√ß√£o: "]?.includes("Token")) {
          alert("Token inv√°lido ou expirado. Fa√ßa login novamente.");
          localStorage.removeItem("token");
          window.location.href = "/login";
          return;
        }

        listaCompletaEstabelecimentos = dados["Dados: "] || [];
        renderizarEstabelecimentos(listaCompletaEstabelecimentos);
      })
      .catch(error => {
        console.error("Erro ao buscar estabelecimentos:", error);
        alert("Erro ao autenticar. Fa√ßa login novamente.");
        localStorage.removeItem("token");
        window.location.href = "/login";
      });
    });

    function renderizarEstabelecimentos(estabelecimentos) {
      const container = document.getElementById("estabelecimentoContainer");
      container.innerHTML = "";

      if (!Array.isArray(estabelecimentos) || estabelecimentos.length === 0) {
        container.innerHTML = "<p class='text-center'>Nenhum estabelecimento encontrado.</p>";
        return;
      }

      estabelecimentos.forEach(est => {
        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
          <img src="${est.imagem || 'https://via.placeholder.com/80'}" alt="${est.nome}" />
          <div class="card-body">
            <h5 class="card-title">${est.nome || "Estabelecimento"}</h5>
           <!-- <p class="card-text"><strong>ID:</strong> ${est.id}</p> -->
            <p class="card-text"><strong>Email:</strong> ${est.email || '-'}</p>
            <p class="card-text"><strong>Telefone:</strong> ${est.telefone || '-'}</p>
          </div>
          <button class="btn btn-primary" onclick="selecionarEstabelecimento(${est.id})">Selecionar</button>
        `;

        container.appendChild(card);
      });
    }

    function filtrarEstabelecimentos() {
      const termo = document.getElementById("inputPesquisa").value.trim().toLowerCase();
      const filtrados = listaCompletaEstabelecimentos.filter(est =>
        est.nome?.toLowerCase().includes(termo)
      );
      renderizarEstabelecimentos(filtrados);
    }

    function selecionarEstabelecimento(id) {
      alert("Estabelecimento selecionado: " + id);
      // localStorage.setItem("estabelecimentoId", id);
      // window.location.href = "/proxima-pagina";
    }
</script>
</body>
</html>
